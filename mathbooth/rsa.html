<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ•°å­¦ãƒ–ãƒ¼ã‚¹ - RSAæš—å·</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(to bottom right, #cce4f6, #ffffff, #c3f7cc);
      color: #333;
    }
    header {
      background-color: white;
      padding: 1em 2em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    header h1 { color: #1e3a8a; margin: 0; font-size: 1.25rem; }
    nav button {
      margin-left: 0.5em;
      padding: 0.5em 0.9em;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 6px;
    }
    section {
      max-width: 980px;
      margin: 2em auto;
      padding: 1em 1.2em;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    h2 { margin-top: 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    label { display: inline-flex; align-items: center; gap: 0.4rem; }
    input[type="number"], input[type="text"] { padding: 0.4rem 0.6rem; border: 1px solid #ccc; border-radius: 6px; width: 200px; }
    input[readonly] { background: #fafafa; }
    button.primary { background: #1e3a8a; color: white; border: none; padding: 0.6rem 0.9rem; border-radius: 8px; cursor: pointer; }
    button.ghost { background: white; border: 1px solid #ccc; padding: 0.5rem 0.8rem; border-radius: 8px; cursor: pointer; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    details { background: #f7fafc; padding: 0.8rem; border-radius: 8px; border: 1px solid #e5e7eb; }
    .keybox { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.8rem; }
    .muted { color: #666; }
    .warn { color: #b45309; }
    .ok { color: #065f46; }
    footer { margin: 2rem 0; text-align: center; color: #666; font-size: 0.9rem; }
    .sep { height: 1px; background: #eee; margin: 1rem 0; }
    .stack { display: grid; gap: 0.6rem; }
  </style>
</head>
<body>
  <header>
    <h1>ä½“æ„Ÿã™ã‚‹æ•°å­¦</h1>
    <nav>
      <button onclick="location.reload()">ãƒªã‚»ãƒƒãƒˆ</button>
    </nav>
  </header>

  <section>
    <h2>ğŸ” RSAæš—å·ã‚’ä½“é¨“ã™ã‚‹</h2>
    <p class="muted">2ã¤ã®ç´ æ•° <em>p</em> ã¨ <em>q</em> ã‚’å…¥åŠ›ã—ã¦éµã‚’ç”Ÿæˆã—ã€æ•°å€¤ã®å¹³æ–‡ã‚’æš—å·åŒ–ãƒ»å¾©å·ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>

    <div class="grid">
      <div class="stack">
        <h3>1) ç´ æ•°ã®å…¥åŠ›</h3>
        <div class="row">
          <label>pï¼š<input id="pInput" type="text" inputmode="numeric" placeholder="ä¾‹) 61" value="61"></label>
          <label>qï¼š<input id="qInput" type="text" inputmode="numeric" placeholder="ä¾‹) 53" value="53"></label>
          <button class="primary" onclick="generateKeys()">éµã‚’ç”Ÿæˆ</button>
        </div>
        <small class="muted">â€» æ•™æç”¨ãªã®ã§å°ã•ã‚ã®ç´ æ•°ã§OKã§ã™ã€‚å¤§ãã™ãã‚‹ã¨é…ããªã‚Šã¾ã™ã€‚</small>

        <div id="keyStatus" class="stack"></div>

        <div class="keybox">
          <div><strong>å…¬é–‹éµ (n, e)</strong></div>
          <div class="row"><label>nï¼š<input id="nOut" type="text" readonly style="width: 100%"></label></div>
          <div class="row"><label>eï¼š<input id="eOut" type="text" readonly></label></div>
          <div class="sep"></div>
          <div><strong>ç§˜å¯†éµ (n, d)</strong></div>
          <div class="row"><label>dï¼š<input id="dOut" type="text" readonly style="width: 100%"></label></div>
          <div class="sep"></div>
          <div class="row"><label>Ï†(n)ï¼š<input id="phiOut" type="text" readonly style="width: 100%"></label></div>
        </div>
      </div>

      <div class="stack">
        <h3>2) æš—å·åŒ–ãƒ»å¾©å·</h3>
        <div class="row">
          <label>å¹³æ–‡ï¼ˆæ•°å€¤ mï¼‰ï¼š<input id="mInput" type="text" inputmode="numeric" placeholder="ä¾‹) 42"></label>
          <button class="ghost" onclick="encryptMsg()">æš—å·åŒ–</button>
        </div>
        <div class="row">
          <label>æš—å·æ–‡ï¼ˆæ•°å€¤ cï¼‰ï¼š<input id="cInput" type="text" inputmode="numeric" placeholder="æš—å·åŒ–ã®çµæœãŒå…¥ã‚Šã¾ã™"></label>
          <button class="ghost" onclick="decryptMsg()">å¾©å·</button>
        </div>
        <small class="muted">â€» æ¡ä»¶ï¼š0 â‰¤ m < n ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</small>
        <div id="ioStatus" class="stack"></div>
      </div>
    </div>

    <details style="margin-top:1rem;">
      <summary>èª¬æ˜ã‚’è¡¨ç¤º</summary>
      <div class="stack">
        <div>1. n = pÃ—qã€Ï† = (pâˆ’1)(qâˆ’1)</div>
        <div>2. e ã¯ Ï† ã¨äº’ã„ã«ç´ ãªå…¬é–‹æŒ‡æ•°ï¼ˆæ—¢å®šã¯ 65537ï¼‰ã€‚</div>
        <div>3. d ã¯ e ã® Ï† ã«é–¢ã™ã‚‹é€†å…ƒï¼ˆed â‰¡ 1 (mod Ï†)ï¼‰ã€‚</div>
        <div>4. æš—å·åŒ–ï¼šc â‰¡ m^e mod nã€å¾©å·ï¼šm â‰¡ c^d mod nã€‚</div>
      </div>
    </details>

    <footer>Â© 2025 æ•°å­¦ãƒ–ãƒ¼ã‚¹</footer>
  </section>

  <script>
    // ===== Utility: BigInt helpers =====
    const toBigInt = (v) => {
      if (typeof v === 'bigint') return v;
      if (typeof v === 'number') return BigInt(v);
      const s = String(v).trim();
      if (!/^[-+]?\d+$/.test(s)) throw new Error('æ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
      return BigInt(s);
    };

    const abs = (x) => (x < 0n ? -x : x);

    const gcd = (a, b) => {
      a = abs(toBigInt(a)); b = abs(toBigInt(b));
      while (b) { const t = a % b; a = b; b = t; }
      return a;
    };

    // æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰: è¿”ã‚Šå€¤ã¯ [g, x, y] (ax + by = g)
    const egcd = (a, b) => {
      a = toBigInt(a); b = toBigInt(b);
      let x = 1n, y = 0n, u = 0n, v = 1n;
      while (b) {
        const q = a / b; // å•†
        [a, b] = [b, a - q * b];
        [x, u] = [u, x - q * u];
        [y, v] = [v, y - q * v];
      }
      return [a, x, y];
    };

    // é€†å…ƒ: a^{-1} mod m
    const modInv = (a, m) => {
      const [g, x] = egcd(a % m + m, m);
      if (g !== 1n) throw new Error('é€†å…ƒãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆäº’ã„ã«ç´ ã§ãªã„ï¼‰');
      return (x % m + m) % m;
    };

    // a^b mod mï¼ˆç¹°ã‚Šè¿”ã—2ä¹—æ³•ï¼‰
    const modPow = (a, b, m) => {
      a = (toBigInt(a) % m + m) % m;
      b = toBigInt(b);
      let res = 1n;
      while (b > 0n) {
        if (b & 1n) res = (res * a) % m;
        a = (a * a) % m;
        b >>= 1n;
      }
      return res;
    };

    // ç°¡æ˜“ç´ æ•°åˆ¤å®šï¼ˆå°ã•ã„æ•°å‘ã‘ + ã„ãã¤ã‹ã®åº•ã§Miller-Rabinï¼‰
    const isProbablePrime = (n) => {
      n = toBigInt(n);
      if (n < 2n) return false;
      const small = [2n,3n,5n,7n,11n,13n,17n,19n,23n,29n,31n,37n];
      if (small.includes(n)) return true;
      for (const p of small) { if (n % p === 0n) return false; }
      // n-1 = d * 2^s
      let d = n - 1n, s = 0n;
      while ((d & 1n) === 0n) { d >>= 1n; s++; }
      const bases = [2n, 7n, 61n]; // 32bitæœªæº€ç¢ºå®šã€æ•™æç”¨é€”ã«ã¯ååˆ†
      const check = (a) => {
        if (a % n === 0n) return true;
        let x = modPow(a, d, n);
        if (x === 1n || x === n - 1n) return true;
        for (let r = 1n; r < s; r++) {
          x = (x * x) % n;
          if (x === n - 1n) return true;
        }
        return false;
      };
      return bases.every(check);
    };

    // ===== UI State =====
    let state = {
      p: null, q: null, n: null, phi: null, e: null, d: null
    };

    const setText = (id, v) => document.getElementById(id).value = v == null ? '' : String(v);
    const pushMsg = (id, html) => {
      const box = document.getElementById(id);
      box.innerHTML = html + box.innerHTML; // ä¸Šã«ç©ã‚€
    };
    const clearMsg = (id) => { document.getElementById(id).innerHTML = ''; };

    function generateKeys() {
      clearMsg('keyStatus');
      try {
        const p = toBigInt(document.getElementById('pInput').value);
        const q = toBigInt(document.getElementById('qInput').value);
        if (p === q) throw new Error('p ã¨ q ã¯ç•°ãªã‚‹ç´ æ•°ã«ã—ã¦ãã ã•ã„');
        if (!isProbablePrime(p)) throw new Error('p ãŒç´ æ•°ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆã¾ãŸã¯ä¸é©åˆ‡ã§ã™ï¼‰');
        if (!isProbablePrime(q)) throw new Error('q ãŒç´ æ•°ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆã¾ãŸã¯ä¸é©åˆ‡ã§ã™ï¼‰');

        const n = p * q;
        const phi = (p - 1n) * (q - 1n);

        // æ—¢å®šã® e
        let e = 65537n;
        if (gcd(e, phi) !== 1n) {
          // Ï†ã¨äº’ã„ã«ç´ ã«ãªã‚‹ã¾ã§å¥‡æ•°ã‚’æ¢ã™ï¼ˆæ•™æç”¨é€”ã€ç°¡æ˜“ï¼‰
          e = 3n;
          while (e < phi && gcd(e, phi) !== 1n) e += 2n;
          if (e >= phi) throw new Error('äº’ã„ã«ç´ ãªå…¬é–‹æŒ‡æ•° e ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
        }
        const d = modInv(e, phi);

        state = { p, q, n, phi, e, d };
        setText('nOut', n);
        setText('eOut', e);
        setText('dOut', d);
        setText('phiOut', phi);

        pushMsg('keyStatus', `<div class="ok">éµç”Ÿæˆã«æˆåŠŸã—ã¾ã—ãŸ</div>`);
        clearMsg('ioStatus');
      } catch (err) {
        pushMsg('keyStatus', `<div class="warn">${err.message}</div>`);
      }
    }

    function encryptMsg() {
      clearMsg('ioStatus');
      try {
        const { n, e } = state;
        if (!n || !e) throw new Error('å…ˆã«éµã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
        const m = toBigInt(document.getElementById('mInput').value);
        if (m < 0n) throw new Error('å¹³æ–‡ m ã¯ 0 ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
        if (m >= n) throw new Error(`å¹³æ–‡ m ã¯ n ã‚ˆã‚Šå°ã•ãã—ã¦ãã ã•ã„ï¼ˆm < nï¼‰ã€‚ç¾åœ¨ n = ${n}`);
        const c = modPow(m, e, n);
        setText('cInput', c);
        pushMsg('ioStatus', `<div class="ok">æš—å·åŒ–ã—ã¾ã—ãŸï¼š c = m^e mod n</div>`);
      } catch (err) {
        pushMsg('ioStatus', `<div class="warn">${err.message}</div>`);
      }
    }

    function decryptMsg() {
      clearMsg('ioStatus');
      try {
        const { n, d } = state;
        if (!n || !d) throw new Error('å…ˆã«éµã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
        const c = toBigInt(document.getElementById('cInput').value);
        if (c < 0n) throw new Error('æš—å·æ–‡ c ã¯ 0 ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
        if (c >= n) throw new Error(`æš—å·æ–‡ c ã¯ n ã‚ˆã‚Šå°ã•ãã—ã¦ãã ã•ã„ï¼ˆc < nï¼‰ã€‚ç¾åœ¨ n = ${n}`);
        const m = modPow(c, d, n);
        setText('mInput', m);
        pushMsg('ioStatus', `<div class="ok">å¾©å·ã—ã¾ã—ãŸï¼š m = c^d mod n</div>`);
      } catch (err) {
        pushMsg('ioStatus', `<div class="warn">${err.message}</div>`);
      }
    }
  </script>
</body>
</html>

