<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä½“æ„Ÿã™ã‚‹æ•°å­¦ - ãƒã‚¤ãƒãƒˆãƒ­ã‚³ã‚¤ãƒ‰</title>
  <style>
    :root{ --bg1:#cce4f6; --bg2:#ffffff; --bg3:#c3f7cc; --ink:#333; --primary:#1e3a8a; }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial; color:var(--ink); background:linear-gradient(to bottom right, var(--bg1), var(--bg2), var(--bg3)); }
    header{ background:#fff; padding:1rem 1.5rem; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 6px rgba(0,0,0,.06); }
    header h1{ margin:0; color:var(--primary); font-size:1.25rem; }
    section{ max-width:1000px; margin:1.5rem auto; background:#fff; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,.08); padding:1rem; }
    .grid{ display:grid; gap:1rem; grid-template-columns: 1fr 1fr; }
    @media (max-width:860px){ .grid{ grid-template-columns: 1fr; } }
    .controls{ display:grid; gap:.8rem; }
    .row{ display:flex; flex-wrap:wrap; align-items:center; gap:.6rem; }
    label{ display:inline-flex; align-items:center; gap:.4rem; }
    input[type="number"], input[type="range"], input[type="text"]{ padding:.45rem .6rem; border:1px solid #d0d7de; border-radius:8px; }
    input[type="range"]{ width:220px; }
    .btn{ padding:.55rem .9rem; border-radius:10px; cursor:pointer; border:1px solid #d0d7de; background:#fff; }
    .btn.primary{ background:var(--primary); color:#fff; border:none; }
    .btn.warn{ border-color:#f3b; }
    .muted{ color:#666; }
    .swatch{ width:1rem; height:1rem; border-radius:50%; border:1px solid #ccc; display:inline-block; vertical-align:middle; }
    canvas{ display:block; width:100%; max-width:100%; border:1px solid #aaa; background:#fafafa; border-radius:12px; }
    .list{ font-size:.92rem; }
    .list table{ width:100%; border-collapse:collapse; }
    .list th, .list td{ padding:.4rem .5rem; border-bottom:1px solid #eee; }
  </style>
</head>
<body>
  <header>
    <h1>ä½“æ„Ÿã™ã‚‹æ•°å­¦</h1>
    <nav>
      <button class="btn" onclick="location.reload()">ãƒªã‚»ãƒƒãƒˆ</button>
    </nav>
  </header>

  <section>
    <h2>ğŸŒ€ ãƒã‚¤ãƒãƒˆãƒ­ã‚³ã‚¤ãƒ‰ï¼ˆHypotrochoidï¼‰ã‚’ä½“é¨“ã™ã‚‹</h2>
    <p class="muted">å›ºå®šå††ã®å†…å´ã‚’å°å††ãŒè»¢ãŒã‚Šã€ãã®å°å††ã®å†…éƒ¨ã®ç‚¹ãŒæãè»Œè·¡ã§ã™ã€‚<br>å…¥åŠ›ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§<strong>æ›²ç·šã‚’è¿½åŠ </strong>ã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã«é‡ã­æãã•ã‚Œã¾ã™ï¼ˆã‚¯ãƒªã‚¢ã™ã‚‹ã¾ã§æ®‹ã‚Šã¾ã™ï¼‰ã€‚</p>

    <div class="grid">
      <div class="controls">
        <h3>1) ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
        <div class="row">
          <label>å›ºå®šå†† åŠå¾„ <em>R</em>ï¼š<input id="R" type="number" value="220" min="1" step="1"></label>
          <label>å°å†† åŠå¾„ <em>r</em>ï¼š<input id="r" type="number" value="80" min="1" step="1"></label>
        </div>
        <div class="row">
          <label>ç‚¹ã®ä½ç½®ï¼ˆå°å††åŠå¾„ã«å¯¾ã™ã‚‹%ï¼‰ï¼š<input id="ratio" type="number" value="60" min="0" max="100" step="1"></label>
          <input id="ratioRange" type="range" value="60" min="0" max="100" step="1" oninput="ratio.value=this.value" onchange="ratio.value=this.value">
        </div>
        <div class="row">
          <label>ç·šå¹…ï¼š<input id="lw" type="number" value="1.8" min="0.5" max="4" step="0.1"></label>
          <label>ä¸é€æ˜åº¦ï¼š<input id="alpha" type="number" value="0.95" min="0.1" max="1" step="0.05"></label>
          <label>è‰²ï¼š<input id="color" type="text" placeholder="è‡ªå‹•ï¼ˆHSLï¼‰"></label>
        </div>
        <div class="row">
          <button class="btn primary" onclick="addCurve()">æ›²ç·šã‚’è¿½åŠ </button>
          <button class="btn" onclick="clearCanvas()">ã‚¯ãƒªã‚¢</button>
        </div>
        <details>
          <summary>å¼ã¨è£œè¶³</summary>
          <div class="muted">
            x(Î¸) = (R âˆ’ r)cosÎ¸ + d cos\(\frac{Râˆ’r}{r}Î¸\)<br>
            y(Î¸) = (R âˆ’ r)sinÎ¸ âˆ’ d sin\(\frac{Râˆ’r}{r}Î¸\), ãŸã ã— d = (ratio/100)Â·r
            <div>é–‰æ›²ç·šã«ãªã‚‹æœ€å°åŒºé–“ã¯ Î¸ âˆˆ [0, 2Ï€Â·r/gcd(R, r)]ï¼ˆR, r ã¯æ•´æ•°æƒ³å®šï¼‰ã€‚</div>
          </div>
        </details>
      </div>

      <div>
        <canvas id="cv" width="900" height="600"></canvas>
        <div class="list" id="list"></div>
      </div>
    </div>
  </section>

  <script>
    const cv = document.getElementById('cv');
    const ctx = cv.getContext('2d');
    let curves = []; // {R,r,ratio,d,color,lw,alpha}

    function gcdInt(a,b){ a=Math.abs(Math.round(a)); b=Math.abs(Math.round(b)); while(b){ [a,b]=[b,a%b]; } return a||1; }

    function autoColor(i){
      const hue = (i*67)%360; // ç›®ã«å„ªã—ã„åˆ†æ•£
      return `hsl(${hue} 90% 45%)`;
    }

    function addCurve(){
      const R = Number(document.getElementById('R').value);
      const r = Number(document.getElementById('r').value);
      const ratio = Number(document.getElementById('ratio').value);
      const lw = Number(document.getElementById('lw').value);
      const alpha = Number(document.getElementById('alpha').value);
      const colorInput = document.getElementById('color').value.trim();

      if(!(R>0&&r>0)) return alert('R ã¨ r ã¯æ­£ã®æ•°ã«ã—ã¦ãã ã•ã„');
      if(ratio<0||ratio>100) return alert('æ¯”ç‡ã¯ 0ã€œ100 ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„');
      if(r>=R) alert('æ³¨æ„: r < R ã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆå°å††ãŒå›ºå®šå††ã®å†…å´ã§è»¢ãŒã‚‹è¨­å®šï¼‰');

      const d = (ratio/100)*r;
      const color = colorInput || autoColor(curves.length);

      const entry = {R,r,ratio,d,color,lw,alpha};
      curves.push(entry);
      redraw();
      updateList();
    }

    function clearCanvas(){
      curves = [];
      ctx.clearRect(0,0,cv.width,cv.height);
      updateList();
    }

    function redraw(){
      ctx.clearRect(0,0,cv.width,cv.height);
      for(let i=0;i<curves.length;i++){
        drawHypotrochoid(curves[i]);
      }
    }

    function drawHypotrochoid({R,r,d,color,lw,alpha}){
      // ã‚¹ã‚±ãƒ¼ãƒ«ï¼šæ›²ç·šã®æœ€å¤§åŠå¾„ (R-r)+d ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åã‚ã‚‹
      const maxRad = Math.max(1e-9, (R - r) + Math.abs(d));
      const scale = 0.46 * Math.min(cv.width, cv.height) / maxRad;
      const cx = cv.width/2, cy = cv.height/2;

      // é–‰æ›²ç·šã®çµ‚äº†è§’ï¼š2Ï€ * r / gcd(R, r)
      const turns = (2*Math.PI) * (r / gcdInt(R, r));
      const step = Math.PI/720; // åˆ†è§£èƒ½ï¼ˆç´°ã‹ãã—ãŸã„ã¨ãã¯å°ã•ãï¼‰

      ctx.save();
      ctx.lineWidth = lw;
      ctx.globalAlpha = alpha;
      ctx.strokeStyle = color;
      ctx.beginPath();

      for(let t=0; t<=turns+1e-9; t+=step){
        const x = (R - r) * Math.cos(t) + d * Math.cos(((R - r)/r) * t);
        const y = (R - r) * Math.sin(t) - d * Math.sin(((R - r)/r) * t);
        const X = cx + x*scale;
        const Y = cy - y*scale; // ç”»é¢ã¯ y ä¸‹å‘ã
        if(t===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
      }
      ctx.stroke();
      ctx.restore();
    }

    function updateList(){
      const box = document.getElementById('list');
      if(curves.length===0){ box.innerHTML = '<p class="muted">ï¼ˆè¿½åŠ ã—ãŸæ›²ç·šã®ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</p>'; return; }
      const rows = curves.map((c,i)=>`<tr>
          <td>#${i+1}</td>
          <td><span class="swatch" style="background:${c.color}"></span></td>
          <td>R=${c.R}, r=${c.r}, ratio=${c.ratio}%</td>
          <td>ç·šå¹… ${c.lw}</td>
          <td>Î±=${c.alpha}</td>
        </tr>`).join('');
      box.innerHTML = `<table><thead><tr><th>ç•ªå·</th><th>è‰²</th><th>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</th><th>æç”»</th><th>é€æ˜</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨æ•°å€¤ã‚’åŒæœŸ
    const ratio = document.getElementById('ratio');
    const ratioRange = document.getElementById('ratioRange');
    ratio.addEventListener('input', ()=> ratioRange.value = ratio.value);

    // åˆæœŸè¡¨ç¤º
    updateList();
  </script>
</body>
</html>